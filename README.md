# Circuit Breaker Orchestra

–£–º–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ Go —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏.

## üì¶ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–¢—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è**: Closed (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞), Open (–∞–≤–∞—Ä–∏–π–Ω–æ–µ), Half-Open (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
- **–°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ** –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –æ—à–∏–±–æ–∫
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥ –æ—à–∏–±–æ–∫** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫
- **Token Bucket** –¥–ª—è rate limiting –≤ Half-Open —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- **–°–µ–º–∞—Ñ–æ—Ä** –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **Graceful degradation** —Å fallback –∫—ç—à–µ–º
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **Context support** –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –æ—Ç–º–µ–Ω—ã

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
go get github.com/yourusername/circuitbreaker
```

## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```go
package main

import (
    "context"
    "time"
    "github.com/yourusername/circuitbreaker"
)

func main() {
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    config := circuitbreaker.DefaultConfig()
    config.Name = "payment-service"
    config.ErrorThreshold = 30.0 // 30% –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
    config.OpenTimeout = 30 * time.Second
    
    // –°–æ–∑–¥–∞–Ω–∏–µ Circuit Breaker
    cb := circuitbreaker.NewCircuitBreaker(config)
    
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
    ctx := context.Background()
    resp, err := cb.Execute(ctx, func() (Response, error) {
        return yourAPICall(ctx, request)
    })
}
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```go
config := circuitbreaker.Config{
    Name:                      "payment-service",
    ErrorThreshold:            50.0,                    // –ü–æ—Ä–æ–≥ –æ—à–∏–±–æ–∫ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    OpenTimeout:               30 * time.Second,        // –í—Ä–µ–º—è –≤ Open —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    WindowSize:                100,                     // –†–∞–∑–º–µ—Ä —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞
    MinRequests:               10,                      // –ú–∏–Ω. –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è
    MaxConcurrentRequests:     5,                       // –ú–∞–∫—Å. –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Half-Open
    HalfOpenBucketSize:        10,                      // –†–∞–∑–º–µ—Ä —Ç–æ–∫–µ–Ω –±–∞–∫–µ—Ç–∞
    HalfOpenRefillRate:        2.0,                     // –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    AdaptiveThresholdFactor:   0.3,                      // –ö–æ—ç—Ñ. –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Ä–æ–≥–∞
    FallbackCache:             myCache,                  // –ö—ç—à –¥–ª—è fallback –æ—Ç–≤–µ—Ç–æ–≤
    MetricsCollector:          myMetrics,                // –°–±–æ—Ä—â–∏–∫ –º–µ—Ç—Ä–∏–∫
}
```

### Graceful degradation —Å –∫—ç—à–µ–º

```go
// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ FallbackCache
type RedisCache struct {
    client *redis.Client
}

func (c *RedisCache) Get(req Request) (Response, bool) {
    val, err := c.client.Get(req.(string)).Result()
    if err != nil {
        return nil, false
    }
    return val, true
}

func (c *RedisCache) Set(req Request, resp Response) {
    c.client.Set(req.(string), resp, 5*time.Minute)
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
cache := &RedisCache{client: redisClient}
config.FallbackCache = cache
cb := circuitbreaker.NewCircuitBreaker(config)
```

### –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞

```go
// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ MetricsCollector
type PrometheusCollector struct {
    errors   prometheus.Counter
    successes prometheus.Counter
}

func (p *PrometheusCollector) RecordError() {
    p.errors.Inc()
}

func (p *PrometheusCollector) RecordSuccess() {
    p.successes.Inc()
}

func (p *PrometheusCollector) GetErrorRate() float64 {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏–∑ Prometheus
    return calculateErrorRate()
}
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```go
// –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
metrics := cb.GetMetrics()
fmt.Printf("State: %s\n", metrics.State)
fmt.Printf("Failures: %d\n", metrics.Failures)
fmt.Printf("Successes: %d\n", metrics.Successes)
fmt.Printf("Error Rate: %.2f%%\n", metrics.ErrorRate)
fmt.Printf("Available Tokens: %d\n", metrics.AvailableTokens)
```

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–æ—Å—Ç–æ—è–Ω–∏—è

1. **Closed (–ó–∞–∫—Ä—ã—Ç)**
   - –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
   - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
   - –ü–æ–¥—Å—á–µ—Ç –æ—à–∏–±–æ–∫ –≤ —Å–∫–æ–ª—å–∑—è—â–µ–º –æ–∫–Ω–µ
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ ‚Üí Open

2. **Open (–û—Ç–∫—Ä—ã—Ç)**
   - –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º
   - –ó–∞–ø—Ä–æ—Å—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
   - –í–æ–∑–≤—Ä–∞—Ç fallback –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –∫—ç—à–∞
   - –ß–µ—Ä–µ–∑ N —Å–µ–∫—É–Ω–¥ ‚Üí Half-Open

3. **Half-Open (–ü–æ–ª—É–æ—Ç–∫—Ä—ã—Ç)**
   - –†–µ–∂–∏–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (token bucket + semaphore)
   - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Üí Closed
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí Open

### –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥

–ü–æ—Ä–æ–≥ –æ—à–∏–±–æ–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫:
```
adaptiveThreshold = configuredThreshold * (1 - factor) + historicalRate * factor
```

### Token Bucket –≤ Half-Open

- –ë–∞–∫–µ—Ç —Å N —Ç–æ–∫–µ–Ω–∞–º–∏
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Ç–æ–∫–µ–Ω
- –¢–æ–∫–µ–Ω—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å –∑–∞–¥–∞–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ–º–∞—Ñ–æ—Ä –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
go test -v -race ./...
```

### –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç-–∫–µ–π—Å–∞

```go
func TestCircuitBreaker_OpenOnErrors(t *testing.T) {
    cb := NewCircuitBreaker(DefaultConfig())
    
    // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
    for i := 0; i < 20; i++ {
        cb.Execute(ctx, failingRequest)
    }
    
    if cb.State() != StateOpen {
        t.Error("Circuit breaker should be open")
    }
}
```

## üìä –ü—Ä–∏–º–µ—Ä—ã

–°–º–æ—Ç—Ä–∏—Ç–µ [main.go](main.go) –¥–ª—è –ø–æ–ª–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:
- –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –æ—à–∏–±–æ–∫
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- Graceful degradation —Å –∫—ç—à–µ–º
- Half-Open –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Å—á–µ—Ç—á–∏–∫–æ–≤
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏** (—Å–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π)
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π** –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø—É—Ç–∏
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ** —á–µ—Ä–µ–∑ container/ring

## üîí –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ thread-safe –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
- atomic –ø–∞–∫–µ—Ç –¥–ª—è —á–∞—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- sync.RWMutex –¥–ª—è —Ä–µ–¥–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
- sync.Once –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

## üìà –ú–µ—Ç—Ä–∏–∫–∏

–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ GetMetrics():
- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –æ–∫–Ω–µ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫
- –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è Open —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã

## üéØ Use Cases

- **–ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—Ç–∫–∞–∑–æ–≤** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ª–∞–≤–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –æ—à–∏–±–æ–∫
- **–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** - –Ω–µ —Ç—Ä–∞—Ç–∏–º —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ –∑–∞–≤–µ–¥–æ–º–æ –ø–∞–¥–∞—é—â–∏–π —Å–µ—Ä–≤–∏—Å
- **–ü–ª–∞–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
- **Graceful degradation** - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–±–æ—è—Ö

### 2. –ì–æ—Ç–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- [gobreaker](https://github.com/sony/gobreaker) - –æ—Ç Sony
- [hystrix-go](https://github.com/afex/hystrix-go) - –ø–æ—Ä—Ç Hystrix
